<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Smart Card</title>
    <link rel="icon" type="image/jpg" href="assets/logo.jpg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="/manifest.json">
    <style>
        /* Card Aspect Ratio (2:3) Container Trick */
        .card-ratio-container {
            padding-bottom: 150%; 
            position: relative;
        }

        .card-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* --- Color Scheme for Contrast/Quality --- */
        /* Body and Main Container are light gray (user request) */
        body, #main-container {
            background-color: #f3f4f6; /* light gray */
        }
        
        /* Dark Mode adjustments */
        .dark body, .dark #main-container {
            background-color: #111827; 
            color: #f3f4f6;
        }
        
        /* Sidebar is dark gray in Light Mode for white icon contrast */
        #sidebar {
            background-color: #1f2937; /* Darker Gray for contrast */
        }
        .dark #sidebar {
            background-color: #111827; 
        }

        /* General Dark Mode adjustments for content */
        .dark .bg-white {
            background-color: #1f2937;
        }
        .dark .text-gray-900 {
            color: #f3f4f6;
        }
        .dark input, .dark textarea {
            background-color: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }
        
        /* Hide photo input when editing */
        .editing .photo-input {
            display: none;
        }
        
        /* ðŸŽ¨ Custom Scrollbar CSS ðŸŽ¨ */
        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        *::-webkit-scrollbar-corner {
            background: rgba(0, 0, 0, 0);
        }
        *::-webkit-scrollbar-thumb {
            background: rgb(153, 153, 153);
            border-radius: 4px;
        }
        *::-webkit-scrollbar-thumb:hover {
            background: rgb(100, 100, 100);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
</head>
<body class="font-sans min-h-screen transition-colors duration-300">

    <!-- External Sidebar Toggle Button (NEW POSITION) -->
    <button id="externalToggle" class="fixed top-4 left-4 p-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 z-50">
        <i id="externalToggleIcon" class="fas fa-bars text-xl"></i>
    </button>

    <!-- Sidebar: Dark background, White icons/text -->
    <div id="sidebar" class="fixed top-0 left-0 h-full shadow-xl flex flex-col justify-between transition-transform duration-300 z-40 transform -translate-x-full w-64">
        
        <div class="flex flex-col pt-20">
            <nav class="flex flex-col p-4 space-y-2">
                
                <!-- Sidebar Option: Home (text-white for contrast) -->
                <a href="#" id="homeButton" class="flex items-center p-3 text-white hover:bg-indigo-500 rounded-xl transition duration-150" onclick="showView('home'); return false;">
                    <i class="fas fa-home text-xl w-8 text-center"></i>
                    <span class="ml-4 font-medium whitespace-nowrap">Home</span>
                </a>
                
                <!-- Sidebar Option: Create New (text-white for contrast) -->
                <button id="createCardButton" class="flex items-center p-3 text-white hover:bg-indigo-500 rounded-xl transition duration-150" onclick="openCreateModal();">
                    <i class="fas fa-plus-circle text-xl w-8 text-center"></i>
                    <span class="ml-4 font-medium whitespace-nowrap">Create New</span>
                </button>
                
                <!-- Sidebar Option: Trash Bin (text-white for contrast) -->
                <a href="#" id="trashButton" class="flex items-center p-3 text-white hover:bg-red-500 rounded-xl transition duration-150" onclick="showView('trash'); return false;">
                    <i class="fas fa-trash text-xl w-8 text-center"></i>
                    <span class="ml-4 font-medium whitespace-nowrap">Trash Bin</span>
                </a>

            </nav>
        </div>

        <div class="p-4">
             <!-- Sidebar Option: Dark Mode Toggle (text-white for contrast) -->
             <button id="darkModeToggle" class="flex items-center w-full p-3 text-white hover:bg-indigo-500 rounded-xl transition duration-150">
                <i class="fas fa-moon text-xl w-8 text-center"></i>
                <span class="ml-4 font-medium whitespace-nowrap">Dark Mode</span>
            </button>
        </div>
    </div>
    
    <!-- Overlay to close sidebar on outside click -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden" onclick="setSidebarState(false)"></div>


    <!-- Main container: Always 100% width, full screen experience -->
    <main id="main-container" class="transition-all duration-300 min-h-screen p-6 w-full">

        <section id="home-view" class="view">
            <h1 class="text-3xl font-extrabold mb-8 text-gray-900 dark:text-gray-100 transition-colors">My Contact Cards</h1>
            <div id="card-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
        </section>

        <section id="trash-view" class="view hidden">
            <h1 class="text-3xl font-extrabold mb-8 text-gray-900 dark:text-gray-100">Trash Bin</h1>
            <div id="trash-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </section>

        <!-- Card Modal (omitted for brevity, assume content is the same) -->
        <div id="cardModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="p-6 sm:p-10">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="modalTitle" class="text-2xl font-bold text-gray-900 dark:text-gray-100">Card Form</h2>
                        <button id="closeModal" class="text-gray-500 hover:text-gray-900 dark:hover:text-gray-100 transition">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <form id="newCardForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" id="cardId" name="cardId"> 

                        <div class="md:col-span-2 photo-input">
                            <label for="cardPhoto" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Photo (Upload New)</label>
                            <input type="file" id="cardPhoto" name="cardPhoto" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150">
                        </div>

                        <div>
                            <label for="cardName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                            <input type="text" id="cardName" name="cardName" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600">
                        </div>

                        <div>
                            <label for="cardProfession" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Profession</label>
                            <input type="text" id="cardProfession" name="cardProfession" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600">
                        </div>

                        <div class="md:col-span-2">
                            <label for="cardDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                            <textarea id="cardDescription" name="cardDescription" rows="3" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600"></textarea>
                        </div>

                        <div>
                            <label for="cardPhone1" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone Number 1</label>
                            <input type="tel" id="cardPhone1" name="cardPhone1" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600">
                        </div>
                        <div>
                            <label for="cardPhone2" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone Number 2 (Optional)</label>
                            <input type="tel" id="cardPhone2" name="cardPhone2" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600">
                        </div>

                        <div class="md:col-span-2">
                            <label for="cardEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email ID</label>
                            <input type="email" id="cardEmail" name="cardEmail" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600">
                        </div>

                        <div class="md:col-span-2">
                            <label for="cardAddress" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Address</label>
                            <input type="text" id="cardAddress" name="cardAddress" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600">
                        </div>

                        <div>
                            <label for="cardInstagramId" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Instagram ID (Optional)</label>
                            <input type="text" id="cardInstagramId" name="cardInstagramId" placeholder="@username" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600">
                        </div>

                        <div>
                            <label for="cardLinkedInUrl" class="block text-sm font-medium text-gray-700 dark:text-gray-300">LinkedIn URL (Optional)</label>
                            <input type="url" id="cardLinkedInUrl" name="cardLinkedInUrl" placeholder="https://linkedin.com/in/..." class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600">
                        </div>

                        <div class="md:col-span-2">
                            <label for="cardWebsiteUrl" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Website/Portfolio URL (Optional)</label>
                            <input type="url" id="cardWebsiteUrl" name="cardWebsiteUrl" placeholder="https://www.mywebsite.com" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600">
                        </div>

                        <div class="md:col-span-2">
                            <label for="cardRelations" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Relations/Notes</label>
                            <textarea id="cardRelations" name="cardRelations" rows="3" class="mt-1 block w-full rounded-lg border border-gray-300 p-3 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:border-gray-600 dark:focus:ring-indigo-600 dark:focus:border-indigo-600"></textarea>
                        </div>

                        <div class="md:col-span-2 mt-4">
                            <button type="submit" id="saveButton" class="w-full inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                                Save Card
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </main>

<script>
(function() {
    
    // --- Configuration and State ---
    const STORAGE_KEY = 'digitalBusinessCards';
    const TRASH_KEY = 'digitalBusinessCardsTrash';
    let isSidebarExpanded = false;
    let isDarkMode = false;
    
    // --- DOM Elements ---
    const html = document.documentElement;
    const sidebar = document.getElementById('sidebar');
    const mainContainer = document.getElementById('main-container'); 
    const externalToggleBtn = document.getElementById('externalToggle');
    const externalToggleIcon = document.getElementById('externalToggleIcon');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const cardGrid = document.getElementById('card-grid');
    const cardModal = document.getElementById('cardModal');
    const closeModalBtn = document.getElementById('closeModal');
    const newCardForm = document.getElementById('newCardForm');
    const modalTitle = document.getElementById('modalTitle');
    const cardIdInput = document.getElementById('cardId');
    const photoInput = document.getElementById('cardPhoto');
    const photoInputDiv = document.querySelector('.photo-input');
    
    // --- Utility and Storage Functions (Unchanged) ---
    function getCards() {
        try {
            const cardsJson = localStorage.getItem(STORAGE_KEY);
            return cardsJson ? JSON.parse(cardsJson) : [];
        } catch (e) {
            console.error("Error reading from localStorage:", e);
            return [];
        }
    }

    function saveCards(cards) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
        } catch (e) {
            console.error("Error writing to localStorage:", e);
        }
    }
    
    function getTrash() {
        const trashJson = localStorage.getItem(TRASH_KEY);
        return trashJson ? JSON.parse(trashJson) : [];
    }

    function saveTrash(trash) {
        localStorage.setItem(TRASH_KEY, JSON.stringify(trash));
    }

    // --- View and Sidebar Management (UPDATED) ---

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        
        const targetView = document.getElementById(`${viewId}-view`);
        if (targetView) {
            targetView.classList.remove('hidden');
        }
        
        // Auto-hide sidebar after navigation click (User Requirement)
        if (isSidebarExpanded) {
            setSidebarState(false);
        }
        
        if (viewId === 'home') {
            renderCards();
        } else if (viewId === 'trash') {
            renderTrashCards();
        }
    }

    /**
     * Toggles the sidebar state (expanded/collapsed).
     */
    window.setSidebarState = function(expanded) { // Made global for onclick in overlay
        isSidebarExpanded = expanded;
        
        // Update the external toggle icon: bars (collapsed), times (expanded)
        externalToggleIcon.className = expanded ? 'fas fa-times text-xl' : 'fas fa-bars text-xl';
        
        if (expanded) {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            sidebarOverlay.classList.remove('hidden');
        } else {
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }
    }

    function updateDarkModeUI() {
        const icon = darkModeToggle.querySelector('i');
        const text = darkModeToggle.querySelector('span');
        
        if (isDarkMode) {
            html.classList.add('dark');
            localStorage.setItem('darkMode', 'true');
            icon.className = 'fas fa-sun text-xl w-8 text-center';
            text.textContent = 'Light Mode';
        } else {
            html.classList.remove('dark');
            localStorage.setItem('darkMode', 'false');
            icon.className = 'fas fa-moon text-xl w-8 text-center';
            text.textContent = 'Dark Mode';
        }
    }

    // --- Card Actions (Updated for Auto-Hide) ---

    window.openCreateModal = function() {
        modalTitle.textContent = 'Create New Card';
        newCardForm.reset();
        cardIdInput.value = '';
        photoInputDiv.classList.remove('editing'); 

        cardModal.classList.add('flex');
        cardModal.classList.remove('hidden');
        
        // Auto-hide sidebar when opening modal (User Requirement)
        if (isSidebarExpanded) {
            setSidebarState(false);
        }
    }

    window.closeModal = function() {
        cardModal.classList.add('hidden');
        cardModal.classList.remove('flex');
        newCardForm.reset();
        cardIdInput.value = '';
        photoInputDiv.classList.remove('editing');
    }
    
    window.deleteCard = function(id) {
        if (!confirm('Move this card to Trash Bin?')) return;
        let cards = getCards();
        const cardToTrash = cards.find(c => c.id === id);
        if (!cardToTrash) return;

        let trash = getTrash();
        trash.push(cardToTrash);
        saveTrash(trash);

        cards = cards.filter(c => c.id !== id);
        saveCards(cards);
        renderCards();
    }

    window.openEditModal = function(id) {
        const cards = getCards();
        const cardToEdit = cards.find(card => card.id === id);

        if (!cardToEdit) return;

        modalTitle.textContent = 'Edit Card';
        
        for (const key in cardToEdit) {
            const input = document.getElementById(`card${key.charAt(0).toUpperCase() + key.slice(1)}`);
            if (input) {
                input.value = cardToEdit[key];
            }
        }
        
        cardIdInput.value = cardToEdit.id;
        photoInputDiv.classList.add('editing');

        cardModal.classList.add('flex');
        cardModal.classList.remove('hidden');
        
        // Auto-hide sidebar when opening modal (User Requirement)
        if (isSidebarExpanded) {
            setSidebarState(false);
        }
    }

    window.exportCardAsImage = async function(cardId, name) {
        const cardElement = document.getElementById(`card-${cardId}`);
        if (!cardElement) return;

        cardElement.classList.add('ring-4', 'ring-indigo-500', 'ring-opacity-50');

        try {
            const canvas = await html2canvas(cardElement, {
                useCORS: true, 
                backgroundColor: null,
                scale: 2 
            });

            canvas.toBlob(function(blob) {
                const link = document.createElement('a');
                link.download = `${name.replace(/\s/g, '_')}_card.png`;
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);
            }, 'image/png');

        } catch (error) {
            console.error("Error exporting card:", error);
        } finally {
            cardElement.classList.remove('ring-4', 'ring-indigo-500', 'ring-opacity-50');
        }
    }

    window.restoreCard = function(id) {
        let trash = getTrash();
        const card = trash.find(c => c.id === id);
        if (!card) return;

        let cards = getCards();
        cards.push(card);
        saveCards(cards);

        trash = trash.filter(c => c.id !== id);
        saveTrash(trash);

        renderTrashCards();
    }

    window.permanentDelete = function(id) {
        if (!confirm('Permanently delete this card?')) return;
        let trash = getTrash().filter(c => c.id !== id);
        saveTrash(trash);
        renderTrashCards();
    }
    
    window.showView = showView; 
    
    // --- Rendering Logic (Unchanged) ---
    function createCardElement(cardData) {
        const cardContainer = document.createElement('div');
        cardContainer.className = 'card-ratio-container';

        const cardContent = document.createElement('div');
        cardContent.className = 'card-content bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-gray-200 dark:border-gray-700 dark:bg-gray-800 p-4 flex flex-col justify-start items-center text-center';
        cardContent.id = `card-${cardData.id}`;
        
        const photoDiv = document.createElement('div');
        photoDiv.className = 'w-24 h-24 sm:w-32 sm:h-32 mb-3 rounded-full overflow-hidden border-4 border-indigo-500 shadow-md flex-shrink-0';
        const photo = document.createElement('img');
        photo.src = cardData.photoUrl;
        photo.alt = `Photo of ${cardData.name}`;
        photo.className = 'w-full h-full object-cover';
        photo.onerror = function() {
            photo.src = 'https://placehold.co/100x100/4F46E5/FFFFFF?text=P'; 
            photo.alt = 'Image Placeholder';
        }
        photoDiv.appendChild(photo);
        cardContent.appendChild(photoDiv);

        cardContent.innerHTML += `
            <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 w-full px-2 mt-1">Name: <span class="text-lg font-bold text-indigo-600 dark:text-indigo-400">${cardData.name}</span></p>
            <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 italic mb-3">Profession: <span class="text-base text-gray-500 dark:text-gray-400">${cardData.profession}</span></p>
        `;

        const descEl = document.createElement('p');
        descEl.className = 'text-xs text-gray-700 dark:text-gray-300 mb-3 overflow-hidden h-8';
        descEl.textContent = cardData.description;
        cardContent.appendChild(descEl);

        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'mt-auto pt-3 border-t border-gray-100 dark:border-gray-700 w-full space-y-1 text-left';
        
        detailsDiv.innerHTML = `
            <p class="text-xs text-gray-600 dark:text-gray-400 flex items-center"><i class="fas fa-phone mr-2 text-indigo-500 w-3"></i> ${cardData.phone1}</p>
            ${cardData.phone2 && cardData.phone2 !== 'N/A' ? `<p class="text-xs text-gray-600 dark:text-gray-400 flex items-center"><i class="fas fa-phone mr-2 text-indigo-500 w-3"></i> ${cardData.phone2}</p>` : ''}
            <p class="text-xs text-gray-600 dark:text-gray-400 flex items-center"><i class="fas fa-envelope mr-2 text-indigo-500 w-3"></i> ${cardData.email}</p>
            <p class="text-xs text-gray-600 dark:text-gray-400 flex items-center"><i class="fas fa-map-marker-alt mr-2 text-indigo-500 w-3"></i> ${cardData.address}</p>
        `;
        cardContent.appendChild(detailsDiv);

        // --- NEW SOCIAL LINKS RENDERING ---
        const socialDiv = document.createElement('div');
        socialDiv.className = 'w-full flex justify-center space-x-4 mt-3';

        // 1. Instagram Link
        if (cardData.instagramId && cardData.instagramId !== 'N/A') {
            const instaLink = document.createElement('a');
            const instaUsername = cardData.instagramId.startsWith('@') ? cardData.instagramId.substring(1) : cardData.instagramId;
            instaLink.href = `https://www.instagram.com/${instaUsername}/`;
            instaLink.target = '_blank';
            instaLink.innerHTML = '<i class="fab fa-instagram text-xl text-pink-600 hover:text-pink-800 transition"></i>';
            instaLink.title = `Instagram: ${cardData.instagramId}`;
            socialDiv.appendChild(instaLink);
        }
        
        // 2. LinkedIn Link
        if (cardData.linkedInUrl && cardData.linkedInUrl !== 'N/A') {
            const linkedInLink = document.createElement('a');
            linkedInLink.href = cardData.linkedInUrl;
            linkedInLink.target = '_blank';
            linkedInLink.innerHTML = '<i class="fab fa-linkedin text-xl text-blue-700 hover:text-blue-900 transition"></i>';
            linkedInLink.title = `LinkedIn: ${cardData.linkedInUrl}`;
            socialDiv.appendChild(linkedInLink);
        }

        // 3. Website Link
        if (cardData.websiteUrl && cardData.websiteUrl !== 'N/A') {
            const websiteLink = document.createElement('a');
            websiteLink.href = cardData.websiteUrl;
            websiteLink.target = '_blank';
            websiteLink.innerHTML = '<i class="fas fa-globe text-xl text-gray-500 hover:text-gray-700 transition"></i>';
            websiteLink.title = `Website: ${cardData.websiteUrl}`;
            socialDiv.appendChild(websiteLink);
        }

        if (socialDiv.children.length > 0) {
            cardContent.appendChild(socialDiv);
        }
        // -----------------------------------

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'absolute top-2 right-2 flex space-x-1 p-1 bg-white dark:bg-gray-800 rounded-lg shadow-md';
        
        const shareBtn = document.createElement('button');
        shareBtn.innerHTML = '<i class="fas fa-share-alt"></i>';
        shareBtn.className = 'text-sm p-1 text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-200 transition';
        shareBtn.title = 'Export as Image (PNG)';
        shareBtn.onclick = () => exportCardAsImage(cardData.id, cardData.name);
        actionsDiv.appendChild(shareBtn);
        
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.className = 'text-sm p-1 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200 transition';
        editBtn.title = 'Edit Card';
        editBtn.onclick = () => openEditModal(cardData.id);
        actionsDiv.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        deleteBtn.className = 'text-sm p-1 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200 transition';
        deleteBtn.title = 'Delete Card';
        deleteBtn.onclick = () => deleteCard(cardData.id);
        actionsDiv.appendChild(deleteBtn);

        cardContent.appendChild(actionsDiv);
        cardContainer.appendChild(cardContent);
        return cardContainer;
    }

    function renderCards() {
        cardGrid.innerHTML = '';
        const cards = getCards();
        
        if (cards.length === 0) {
            cardGrid.innerHTML = '<p class="col-span-full text-center text-lg text-gray-500 dark:text-gray-400 p-10 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">No cards found! Click "Create New" to add your first card.</p>';
            return;
        }

        cards.forEach(card => {
            cardGrid.appendChild(createCardElement(card));
        });
    }

    function renderTrashCards() {
        const trashGrid = document.getElementById('trash-grid');
        trashGrid.innerHTML = '';
        const trash = getTrash();
        
        if (trash.length === 0) {
            trashGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full p-10 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">Trash is empty.</p>';
            return;
        }

        trash.forEach(card => {
            const div = document.createElement('div');
            div.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 flex flex-col items-center text-center';
            div.innerHTML = `
                <img src="${card.photoUrl}" class="w-24 h-24 rounded-full mb-3 object-cover border-4 border-red-500" alt="${card.name}" onerror="this.src='https://placehold.co/100x100/4F46E5/FFFFFF?text=P'">
                <p class="font-bold text-gray-900 dark:text-gray-100">${card.name}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">${card.profession}</p>
                <div class="mt-auto flex space-x-3">
                    <button class="px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 transition" onclick="restoreCard(${card.id})">Restore</button>
                    <button class="px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 transition" onclick="permanentDelete(${card.id})">Delete</button>
                </div>
            `;
            trashGrid.appendChild(div);
        });
    }

    // --- Form Submission Logic (Unchanged) ---

    newCardForm.addEventListener('submit', (e) => {
        e.preventDefault();

        const formData = new FormData(newCardForm);
        const file = formData.get('cardPhoto');
        const id = formData.get('cardId');
        const isEditing = !!id;
        let cards = getCards();
        let cardData = isEditing ? cards.find(c => c.id == id) : {};
        
        const defaultPhoto = 'https://placehold.co/600x900/4F46E5/FFFFFF?text=Photo';

        const finalizeCardUpdate = (photoUrl) => {
            const newOrUpdatedCard = {
                id: isEditing ? parseInt(id) : Date.now(),
                photoUrl: photoUrl || (isEditing ? cardData.photoUrl : defaultPhoto), 
                name: formData.get('cardName') || 'N/A',
                profession: formData.get('cardProfession') || 'N/A',
                description: formData.get('cardDescription') || 'N/A',
                phone1: formData.get('cardPhone1') || 'N/A',
                phone2: formData.get('cardPhone2') || 'N/A',
                email: formData.get('cardEmail') || 'N/A',
                address: formData.get('cardAddress') || 'N/A',
                instagramId: formData.get('cardInstagramId') || 'N/A',
                linkedInUrl: formData.get('cardLinkedInUrl') || 'N/A',
                websiteUrl: formData.get('cardWebsiteUrl') || 'N/A',
                relations: formData.get('cardRelations') || 'N/A',
            };

            if (isEditing) {
                const index = cards.findIndex(c => c.id === newOrUpdatedCard.id);
                if (index !== -1) { cards[index] = newOrUpdatedCard; }
            } else {
                cards.push(newOrUpdatedCard);
            }

            saveCards(cards);
            closeModal();
            renderCards();
        };

        if (file && file.size > 0) {
            const reader = new FileReader();
            reader.onload = function(event) {
                finalizeCardUpdate(event.target.result);
            };
            reader.readAsDataURL(file);
        } else {
            finalizeCardUpdate(isEditing ? cardData.photoUrl : null);
        }
    });

    // --- Initialization and Event Attachments (Updated) ---

    // New: External toggle button listener
    externalToggleBtn.addEventListener('click', () => {
        setSidebarState(!isSidebarExpanded);
    });
    
    // Auto-hide sidebar when clicking a menu item
    document.querySelectorAll('#sidebar a, #sidebar button').forEach(el => {
        // Prevent adding listeners to the Dark Mode toggle as it calls updateDarkModeUI, not showView
        if (el.id !== 'darkModeToggle') {
            el.addEventListener('click', () => {
                 // Check for programmatic actions that don't auto-close (like createCardButton opening modal)
                if (el.id !== 'createCardButton') {
                    setSidebarState(false);
                }
            });
        }
    });

    closeModalBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (event) => {
        if (event.target === cardModal) {
            closeModal();
        }
    });

    // Dark Mode Toggle
    darkModeToggle.addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        updateDarkModeUI();
        setSidebarState(false); // Auto-hide after toggling mode
    });

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('SW registered:', registration);
                })
                .catch(error => {
                    console.log('SW registration failed:', error);
                });
        });
    }
    // ---------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize dark mode from localStorage
        if (localStorage.getItem('darkMode') === 'true' || 
            (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            isDarkMode = true;
        }
        
        // Initial state is hidden (User Requirement)
        setSidebarState(false); 
        updateDarkModeUI();
        showView('home'); 
    });
    
})(); 
</script>

</body>
</html>
